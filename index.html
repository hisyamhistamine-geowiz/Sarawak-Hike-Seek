<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sarawak Hike & Seek</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Raleway:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* --- ADVENTURE THEME CSS (UNCHANGED) --- */
        :root {
            --forest-green: #1b4d3e;
            --earth-brown: #5d4037;
            --vibrant-orange: #ff6f00;
            --light-bg: #f4f7f6;
            --text-dark: #263238;
            --white: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-dark);
            font-family: 'Raleway', sans-serif;
            line-height: 1.6;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 C 25 10 50 5 75 20 S 100 10 100 20 M0 30 C 20 40 50 20 80 40 S 100 30 100 40 M0 60 C 30 50 60 70 90 60 S 100 70 100 80' stroke='%235d4037' stroke-width='0.5' fill='none' opacity='0.1'/%3E%3C/svg%3E");
            background-size: 200px 200px; 
        }

        h1, h2, h3 {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--forest-green);
        }

        /* --- NAVIGATION --- */
        nav {
            background-color: var(--forest-green);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo { color: var(--white); font-size: 1.8rem; font-family: 'Oswald', sans-serif; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--vibrant-orange); }

        .nav-links button {
            background: none; border: none; color: rgba(255,255,255,0.8);
            font-family: 'Oswald', sans-serif; font-size: 1.1rem; margin-left: 20px; cursor: pointer; transition: 0.3s;
        }
        .nav-links button:hover, .nav-links button.active { color: var(--vibrant-orange); transform: translateY(-2px); }

        /* --- SECTIONS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 85vh; }
        .section { display: none; animation: fadeIn 0.6s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HERO */
        .hero {
            background: linear-gradient(rgba(27, 77, 62, 0.8), rgba(27, 77, 62, 0.6)), url('https://cgkgxbswgopovdyuexhp.supabase.co/storage/v1/object/public/UI-related/Banner.webp');
            background-size: cover; background-position: center; color: white;
            padding: 100px 20px; text-align: center; border-radius: 12px; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .hero h1 { font-size: 3.5rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); color:white; }
        .cta-btn {
            background-color: var(--vibrant-orange); color: white; padding: 15px 40px;
            font-size: 1.2rem; font-family: 'Oswald', sans-serif; text-transform: uppercase;
            border: none; border-radius: 4px; cursor: pointer; transition: 0.3s;
        }

        /* --- MAP --- */
        #map-container { height: 650px; width: 100%; border-radius: 12px; border: 4px solid var(--white); box-shadow: 0 8px 16px rgba(0,0,0,0.15); z-index: 1; }
        .map-legend { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: bold; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        /* --- POPUP STYLES --- */
        .leaflet-popup-content-wrapper { border-radius: 0; padding: 0; overflow: hidden; }
        
        .leaflet-popup-content { 
            margin: 0; 
            width: 400px !important; 
            max-height: 80vh !important; 
            display: flex;
            flex-direction: column;
        }
        
        .popup-header { 
            background: var(--forest-green); color: white; padding: 15px; 
            flex-shrink: 0; 
        }
        .popup-header h3 { color: var(--vibrant-orange); font-size: 1.3rem; margin: 0; }
        .popup-header div { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
        
        .popup-body { 
            padding: 15px; 
            font-size: 0.95rem; 
            overflow-y: auto; 
            flex-grow: 1;     
        }
        
        .popup-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background-color: #f0f4f3; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .popup-grid-item small { color: #666; font-size: 0.7rem; text-transform: uppercase; }
        .popup-grid-item strong { display: block; color: var(--text-dark); font-size: 0.9rem; }

        .info-label { color: var(--forest-green); font-weight: 700; font-family: 'Oswald', sans-serif; margin-bottom: 2px; display: block; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 2px;}
        
        .details-txt-box {
            background: #fffbe6; border-left: 3px solid var(--vibrant-orange);
            padding: 10px; font-size: 0.9rem; white-space: pre-wrap; margin-bottom: 5px;
            font-style: italic; color: #555;
        }

        /* --- CAROUSEL --- */
        .carousel-container { position: relative; width: 100%; height: 200px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 10px; display: flex; align-items: center; justify-content: center; }
        .carousel-container img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; cursor: zoom-in; }
        .carousel-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; cursor: pointer; font-size: 1.2rem; z-index: 10;
        }
        .prev-btn { left: 0; }
        .next-btn { right: 0; }
        .carousel-counter { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; font-size: 0.7rem; border-radius: 3px; }

        /* --- LIGHTBOX (FULL SCREEN) --- */
        .lightbox {
            display: none;
            position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9);
            align-items: center; justify-content: center;
        }
        .lightbox img { max-width: 95%; max-height: 95%; border: 2px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .lightbox-close {
            position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .lightbox-close:hover { color: var(--vibrant-orange); }

        /* --- ABOUT & CONTACT --- */
        .content-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; border-left: 6px solid var(--vibrant-orange); }
        .contact-link { color: var(--vibrant-orange); text-decoration: none; font-weight: bold; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            nav { flex-direction: column; gap: 15px; padding: 1rem; }
            .nav-links { display: flex; gap: 15px; font-size: 0.9rem; }
            .nav-links button { margin-left: 0; }
            
            .hero { padding: 60px 15px; }
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1.1rem; }

            .container { padding: 10px; }
            .content-box { padding: 20px; }
            
            #map-container { height: 75vh; } 
            
            .leaflet-popup-content { 
                width: 85vw !important; 
                min-width: 280px;
                max-height: 70vh !important;
            }
        }

    </style>
</head>
<body>

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="">
    </div>

    <nav>
        <div class="logo">SARAWAK <span>HIKE & SEEK</span></div>
        <div class="nav-links">
            <button onclick="showSection('home')" id="btn-home" class="active">HOME</button>
            <button onclick="showSection('map')" id="btn-map">EXPLORE MAP</button>
            <button onclick="showSection('seek')" id="btn-seek">SEEKER</button>
            <button onclick="showSection('about')" id="btn-about">ABOUT US</button>
        </div>
    </nav>

    <div class="container">

        <div id="home" class="section active">
            <div class="hero">
                <h1>Discover the Hidden Trails</h1>
                <p>From misty mountains to hidden waterfalls, explore the wild side of Sarawak.</p>
                <br>
                <button class="cta-btn" onclick="showSection('map')">Find Your Adventure</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <div class="content-box" style="border-left-color: var(--forest-green);">
                    <h3>Explore by Category</h3>
                    <p>Filters help you find the perfect trail, from casual walks to hardcore climbs.</p>
                </div>
                <div class="content-box" style="border-left-color: var(--earth-brown);">
                    <h3>Know Before You Go</h3>
                    <p>Get details on difficulty, amenities, and hidden waterfalls.</p>
                </div>
            </div>
        </div>

        <div id="map" class="section">
            <h2 style="margin-bottom: 15px;">Exploration Map</h2>
            <div class="map-legend" id="legend"><span>Loading Categories...</span></div>
            <div id="map-container"></div>
        </div>

        <div id="seek" class="section">
            
            <div id="auth-view" class="content-box" style="text-align: center; display:none;">
                <h2>Join the Hunt üïµÔ∏è‚Äç‚ôÇÔ∏è</h2>
                <p>Sign in to track your hikes, collect points, and climb the Sarawak leaderboard.</p>
                <div style="margin: 30px 0;">
                    <input type="email" id="email-input" placeholder="Enter your email" style="padding: 10px; width: 60%; max-width: 300px; border: 1px solid #ccc; border-radius: 4px;">
                    <br><br>
                    <button class="cta-btn" onclick="handleLogin()">Get Magic Link</button>
                </div>
                <p style="font-size: 0.8rem; color: #666;">We use passwordless login. We'll send a secure link to your email.</p>
            </div>

            <div id="game-view" style="display:none;">
                <div class="content-box" style="margin-bottom: 20px; border-left-color: #e91e63;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="color: #e91e63;">Explorer Dashboard</h3>
                            <p>Signed in as: <strong id="user-email">...</strong></p>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 0.9rem;">YOUR SCORE</span>
                            <div style="font-size: 2.5rem; font-weight: bold; color: #e91e63;" id="user-score">0</div>
                        </div>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                    
                    <button class="cta-btn" onclick="toggleScanner()" style="background-color: #263238; width: 100%;">
                        üì∏ SCAN QR CODE
                    </button>
                    
                    <div id="scanner-container" style="display:none; margin-top: 15px; text-align: center;">
                        <div id="reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                        <button onclick="stopScanner()" style="margin-top:10px; padding:5px 15px; background:#ccc; border:none; cursor:pointer;">Close Camera</button>
                    </div>
                </div>

                <div class="content-box">
                    <h3>üèÜ Top Seekers</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead style="background: #f4f7f6; text-align: left;">
                            <tr>
                                <th style="padding: 10px; border-bottom: 2px solid #ddd;">Rank</th>
                                <th style="padding: 10px; border-bottom: 2px solid #ddd;">Explorer</th>
                                <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align: right;">Points</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="3" style="padding:20px; text-align:center;">Loading leaderboard...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="handleLogout()" style="background:none; border:none; text-decoration:underline; cursor:pointer; color: #666;">Sign Out</button>
                </div>
            </div>
        </div>

        <div id="about" class="section">
            <div class="content-box">
                <h2>About Sarawak Hike & Seek</h2>
                <p>Welcome to the ultimate resource for hikers and nature lovers in Sarawak.</p>
                <br>
                <p><strong>Our Data:</strong> We compile data on trail conditions, difficulty, and natural features. 
                Data used in the website is based on available data on the public internet.</p>
                <br>
                <p><strong>Seeker:</strong> Is a monthly competition  to encourage hikers the exploration of hiking trails in Sarawak, and
                potentially win prizes along the way. The QR codes are placed at key locations along different trails and updated monthly.</p>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <h3>Contact Person</h3>
                <p>For inquiries, collaboration, or trail updates:</p>
                <p style="margin-top:10px;">
                    <strong>Nur Hisyam Ramli</strong><br>
                    <a href="mailto:hisyamhistamine@gmail.com" class="contact-link">hisyamhistamine@gmail.com</a>
                </p>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- CONFIGURATION ---
        // üî¥ TODO: PASTE YOUR ACTUAL KEYS HERE
        const SUPABASE_URL = "https://cgkgxbswgopovdyuexhp.supabase.co"; 
        const SUPABASE_ANON_KEY = "sb_publishable_kv_WkTORoNYKHr3kqTjHMQ_NEXwpxIU"; 
        const TABLE_NAME = "database"; 
        const BUCKET_NAME = "media"; // Make sure this matches your bucket name

        // --- GLOBAL VARIABLES ---
        let map;
        let mapInitialized = false;
        let galleryState = {};
        let supabaseClient = null;

        const categoryColors = {
            "Mountain Trail": "#795548", // Brown
            "Waterfall": "#0288D1",      // Blue
            "Jungle Trek": "#2E7D32",    // Green
            "Park": "#8BC34A",           // Light Green
            "Cave": "#607D8B",           // Grey Blue
            "Hill Trail": "#FF9800",     // Orange
            "default": "#555555"         // Grey
        };

        // --- SAFE INITIALIZATION ---
        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error("Supabase library not loaded.");
            }
        } catch (err) { console.error(err); }

        // --- NAVIGATION LOGIC ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
            
            const section = document.getElementById(id);
            const btn = document.getElementById('btn-' + id);
            
            if (section) section.classList.add('active');
            if (btn) btn.classList.add('active');

            if (id === 'map') {
                if (!mapInitialized) { initMap(); mapInitialized = true; }
                setTimeout(() => { if (map) map.invalidateSize(); }, 200);
            }
        }

        function initMap() {
            if (!document.getElementById('map-container')) return;
            
            // 1. Create the map
            map = L.map('map-container').setView([2.55, 113.0], 7);
            
            // 2. Add Tiles
            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { 
                maxZoom: 17, 
                attribution: 'Map data: &copy; OSM, SRTM | Map style: &copy; OpenTopoMap' 
            }).addTo(map);

            // 3. NEW: Add "Locate Me" Button Control
            const locateControl = L.control({ position: 'topright' });
            
            locateControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = `
                    <button onclick="locateUser()" style="
                        background-color: white;
                        border: none;
                        width: 34px;
                        height: 34px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.2rem;
                        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
                    " title="Show My Location">
                        üìç
                    </button>
                `;
                return div;
            };
            locateControl.addTo(map);

            // 4. Load Data
            loadData();
        }

        async function loadData() {
            if (!supabaseClient) {
                document.getElementById('legend').innerHTML = "<span style='color:red'>Error: Supabase not connected.</span>";
                return;
            }
            try {
                const { data, error } = await supabaseClient.from(TABLE_NAME).select('*');
                if (error) throw error;
                if (data) processData(data);
            } catch (err) {
                console.error("Data Error:", err);
                document.getElementById('legend').innerHTML = "Error loading data.";
            }
        }

        function processData(data) {
            const foundCategories = new Set();
            const markers = L.layerGroup().addTo(map);
            const bounds = L.latLngBounds();

            // Storage URL Construction
            const storageBaseUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}`;

            data.forEach(row => {
                const coordRaw = row.Coordinates || row.coordinates; 
                if (!coordRaw) return;

                const parts = coordRaw.split(',').map(n => parseFloat(n.trim()));
                if (parts.length !== 2 || isNaN(parts[0])) return;

                // Handle data fields (case insensitive fallback)
                const nameRaw = row.Name || row.name || "Unknown";
                const cat = (row.Category || row.category || "default").trim();
                const diff = row.Difficulty || row.difficulty || 'N/A';
                const waterfall = row.Waterfall || row.waterfall || 'No';
                const location = row.Location || row.location || '';
                const amenities = row.Amenities || row.amenities || 'None listed';
                const body = row.Body || row.body || 'No description available.';

                foundCategories.add(cat);
                const color = categoryColors[cat] || categoryColors["default"];

                const marker = L.circleMarker(parts, {
                    radius: 8, fillColor: color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9
                });

                // URL Construction
                const safeName = encodeURIComponent(nameRaw.trim());
                const visualFolder = `${storageBaseUrl}/${safeName}`;
                const uniqueId = nameRaw.replace(/[^a-zA-Z0-9]/g, '');

                const popupContent = `
                    <div class="popup-header">
                        <h3>${nameRaw}</h3>
                        <div>üìç ${location}</div>
                    </div>
                    <div class="popup-body">
                        <div class="popup-grid">
                            <div class="popup-grid-item"><small>Category</small><strong>${cat}</strong></div>
                            <div class="popup-grid-item"><small>Difficulty</small><strong>${diff}</strong></div>
                            <div class="popup-grid-item"><small>Waterfall?</small><strong>${waterfall}</strong></div>
                        </div>

                        <span class="info-label">AMENITIES</span>
                        <p class="info-text">${amenities}</p>

                        <span class="info-label">ABOUT THE TRAIL</span>
                        <p class="info-text">${body}</p>
                        
                        <span class="info-label">TRAIL NOTES (Summary)</span>
                        <div id="details-${uniqueId}" class="details-txt-box">Loading notes...</div>

                        <span class="info-label">PHOTO GALLERY</span>
                        <div id="carousel-${uniqueId}" class="carousel-container">
                            <button class="carousel-btn prev-btn" onclick="prevImage('${uniqueId}')">&#10094;</button>
                            <img id="img-${uniqueId}" src="" alt="Loading..." style="display:none;" onclick="openLightbox(this.src)" />
                            <p id="no-img-${uniqueId}" style="color:#888; display:none; font-size:0.8rem;">No images found</p>
                            <button class="carousel-btn next-btn" onclick="nextImage('${uniqueId}')">&#10095;</button>
                            <div id="counter-${uniqueId}" class="carousel-counter">0/0</div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.on('popupopen', () => { loadExternalMedia(visualFolder, uniqueId); });
                markers.addLayer(marker);
                bounds.extend(parts);
            });

            if (data.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            
            // Generate the legend immediately after processing data
            generateLegend(foundCategories);
        }

        // --- OPTIMIZED IMAGE LOADER (PARALLEL) ---
        async function loadExternalMedia(folderUrl, id) {
            // A. Fetch Details.txt
            fetch(`${folderUrl}/details.txt`)
                .then(res => res.ok ? res.text() : Promise.reject())
                .then(text => { 
                    const box = document.getElementById(`details-${id}`); 
                    if(box) box.innerText = text; 
                })
                .catch(() => { 
                    const box = document.getElementById(`details-${id}`); 
                    if(box) { box.innerText = "No additional notes available."; box.style.background = "#f9f9f9"; }
                });

            // B. Fetch Images (Optimized with Promise.all)
            // Instead of checking 1...wait...2...wait, we check all 5 at once.
            const potentialImages = [1, 2, 3, 4, 5].map(i => `${folderUrl}/${i}.jpg`);

            const checkPromises = potentialImages.map(url => 
                fetch(url, { method: 'HEAD' })
                    .then(res => res.ok ? url : null)
                    .catch(() => null)
            );

            // Wait for all checks to finish
            const results = await Promise.all(checkPromises);
            const validImages = results.filter(url => url !== null);

            galleryState[id] = { images: validImages, index: 0 };
            updateCarousel(id);
        }

        // --- LEGEND GENERATOR ---
        function generateLegend(categories) {
            const legendContainer = document.getElementById('legend');
            if (!legendContainer) return;
            
            legendContainer.innerHTML = ''; 
            categories.forEach(cat => {
                const color = categoryColors[cat] || categoryColors["default"];
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="dot" style="background-color: ${color};"></span> ${cat}`;
                legendContainer.appendChild(item);
            });
        }

        // --- CAROUSEL & LIGHTBOX UTILS ---
        function updateCarousel(id) {
            const state = galleryState[id];
            const imgEl = document.getElementById(`img-${id}`);
            const noImgEl = document.getElementById(`no-img-${id}`);
            const counterEl = document.getElementById(`counter-${id}`);

            if (!imgEl) return;
            if (state.images.length === 0) {
                imgEl.style.display = 'none'; noImgEl.style.display = 'block'; counterEl.style.display = 'none';
                return;
            }
            noImgEl.style.display = 'none'; imgEl.style.display = 'block'; counterEl.style.display = 'block';
            imgEl.src = state.images[state.index];
            counterEl.innerText = `${state.index + 1} / ${state.images.length}`;
        }

        window.nextImage = function(id) {
            const state = galleryState[id];
            if (!state || state.images.length === 0) return;
            state.index = (state.index + 1) % state.images.length;
            updateCarousel(id);
        };
        window.prevImage = function(id) {
            const state = galleryState[id];
            if (!state || state.images.length === 0) return;
            state.index = (state.index - 1 + state.images.length) % state.images.length;
            updateCarousel(id);
        };
        window.openLightbox = function(src) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            lightbox.style.display = 'flex';
            lightboxImg.src = src;
        };
        window.closeLightbox = function() {
            document.getElementById('lightbox').style.display = 'none';
        };
        let userMarker = null; // Global variable to track the user marker

        function locateUser() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            // Change cursor to indicate loading
            document.body.style.cursor = "wait";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const userLoc = [lat, lng];

                    // Reset cursor
                    document.body.style.cursor = "default";

                    // 1. Move Map to User
                    map.flyTo(userLoc, 13, {
                        animate: true,
                        duration: 1.5
                    });

                    // 2. Add or Move the User Marker
                    // We use a standard Blue Pin to distinguish it from the trail circles
                    if (userMarker) {
                        userMarker.setLatLng(userLoc);
                    } else {
                        userMarker = L.marker(userLoc).addTo(map)
                            .bindPopup();
                    }
                },
                (error) => {
                    document.body.style.cursor = "default";
                    console.error("Location Error:", error);
                    let msg = "Could not find your location.";
                    if (error.code === 1) msg = "Please allow location access to see your position.";
                    alert(msg);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }// --- SEEK / GAME VARIABLES ---
        let html5QrcodeScanner = null;
        let currentUser = null;

        // 1. INITIALIZATION: Check if user is logged in
        async function initAuth() {
            // Check current session
            const { data: { session } } = await supabaseClient.auth.getSession();
            updateUI(session);

            // Listen for auth changes (login/logout events)
            supabaseClient.auth.onAuthStateChange((_event, session) => {
                updateUI(session);
            });
        }
        
        // Call this when the page loads!
        initAuth();

        function updateUI(session) {
            const authView = document.getElementById('auth-view');
            const gameView = document.getElementById('game-view');
            
            if (session) {
                // User is logged in
                currentUser = session.user;
                authView.style.display = 'none';
                gameView.style.display = 'block';
                document.getElementById('user-email').innerText = currentUser.email.split('@')[0]; // Show username part of email
                loadLeaderboard();
                loadUserScore();
            } else {
                // User is logged out
                currentUser = null;
                authView.style.display = 'block';
                gameView.style.display = 'none';
            }
        }

        // 2. AUTHENTICATION FUNCTIONS
        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            if (!email) return alert("Please enter an email address.");

            const { error } = await supabaseClient.auth.signInWithOtp({ email: email });
            
            if (error) {
                alert("Error: " + error.message);
            } else {
                alert("Check your email for the magic login link!");
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            alert("Signed out successfully.");
        }

        // 3. SCANNER FUNCTIONS
        function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if (container.style.display === 'block') {
                stopScanner();
            } else {
                container.style.display = 'block';
                startScanner();
            }
        }

        function startScanner() {
            if (html5QrcodeScanner) return; // Already running

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                console.error("Camera start failed", err);
                alert("Could not start camera. Please allow permissions.");
            });
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    document.getElementById('scanner-container').style.display = 'none';
                }).catch(err => console.error("Failed to stop scanner", err));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
                    // 1. Pause the scanner so it doesn't scan 100 times in a second
                    if (html5QrcodeScanner) html5QrcodeScanner.pause();

                    try {
                        // 2. Send the code to Supabase for verification
                        const { data, error } = await supabaseClient.rpc('submit_scan', { 
                            code_text: decodedText 
                        });

                        if (error) throw error;

                        // 3. Handle the result
                        if (data.success) {
                            alert("üéâ " + data.message);
                            loadUserScore();   // Refresh the score display
                            loadLeaderboard(); // Refresh the leaderboard
                        } else {
                            alert("‚ùå " + data.message);
                        }

                    } catch (err) {
                        console.error("Scan Error:", err);
                        alert("Error processing scan. Check your internet.");
                    }

                    // 4. Resume scanning (or stop if you prefer)
                    if (html5QrcodeScanner) html5QrcodeScanner.resume();
                }

        // 4. DATABASE FUNCTIONS (LEADERBOARD)
        async function loadLeaderboard() {
                    try {
                        // 1. CHANGED: Fetch 'email' instead of 'username'
                        const { data, error } = await supabaseClient
                            .from('profiles')
                            .select('email, score')
                            .order('score', { ascending: false })
                            .limit(10);

                        if (error) throw error;

                        const tbody = document.getElementById('leaderboard-body');
                        tbody.innerHTML = '';
                        
                        data.forEach((user, index) => {
                            // 2. LOGIC: Create a "Display Name" from the email
                            // "hisyamhistamine@gmail.com" -> "hisyamhistamine"
                            let displayName = "Anonymous";
                            if (user.email) {
                                displayName = user.email.split('@')[0];
                            }

                            // Highlight current user row
                            const isMe = (currentUser && currentUser.email === user.email) ? "background:#fffbe6;" : "";
                            const rankEmoji = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : (index + 1);
                            
                            const row = `
                                <tr style="border-bottom: 1px solid #eee; ${isMe}">
                                    <td style="padding: 10px;">${rankEmoji}</td>
                                    <td style="padding: 10px;">${displayName}</td>
                                    <td style="padding: 10px; text-align: right; font-weight:bold;">${user.score}</td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });

                    } catch (err) {
                        console.error("Leaderboard error:", err);
                        // If this still fails, check your RLS policies!
                        document.getElementById('leaderboard-body').innerHTML = `<tr><td colspan="3" style="color:red;">Error loading data. Check console.</td></tr>`;
                    }
                }

        async function loadUserScore() {
                    if (!currentUser) return;

                    try {
                        // Fetch the specific row for the currently logged-in user
                        const { data, error } = await supabaseClient
                            .from('profiles')
                            .select('score')
                            .eq('id', currentUser.id)
                            .single();

                        if (error) throw error;

                        // Update the HTML text with the real number
                        // If data.score is null (new user), show 0
                        const currentScore = data.score || 0;
                        document.getElementById('user-score').innerText = currentScore;
                        
                        // Optional: Animate the number for a cool effect
                        // animateValue("user-score", 0, currentScore, 1000);

                    } catch (err) {
                        console.error("Error fetching score:", err);
                    }
                }
    </script>
</body>
</html>